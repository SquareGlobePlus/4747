<html>
  <body>
  <script>
    var tag = document.createElement('script');
    var socket;
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var sp;

    function onYouTubeIframeAPIReady() {
        sp = new SmoothPlayer('player', {
                width: '960px',
                height: '540px',
                onStart: function() {
                    $("#smooth-container").animate({opacity: 1}, 2000);

                    bindPages([
                        ['#about-btn', '#about']
                    ], sp);


                    $('#intro a').animate({opacity: 1}, 1000);
                },
                onResume: function() {
                    refreshControlButton();
                    showResumeText();
                },
                onReady: function() {
                    socket = io();
                    sp.mute();
                    toggleIntro(true);
                    socket.on('video', function(data) {
                        sp.play(data.video.id);
                    });
                }
            });
    }

    function hold() {
        if (socket) {
            socket.emit('control', {
                controlType: 'hold',
                videoId: sp.currentVideoId()
            })
        }
        ga('send', 'event', 'player', 'hold', sp.currentVideoId());
        dataLayer.push({
          'videoID': sp.currentVideoId(),
          'event': 'hold'
        });
        sp.hold();
        refreshControlButton();
    }

    function back() {
        sp.goBack();
        if (socket) {
            socket.emit('control', {
                controlType: 'back',
                videoId: sp.currentVideoId()
            })
        }
        ga('send', 'event', 'player', 'back', sp.currentVideoId());
        refreshControlButton();
    }

    function resume() {
        if (resume) {
            socket.emit('control', {
                controlType: 'resume',
                videoId: sp.currentVideoId()
            })
        }
        ga('send', 'event', 'player', 'resume', sp.currentVideoId());
        sp.resume();
        refreshControlButton();
    }

    function refreshControlButton() {
        var playerState = sp.playerState();
        if (playerState === 'hold') {
            d3.select('#control-btn').classed('hold', true);
        } else if (playerState === 'back') {
            d3.select('#control-btn').classed('hold', true);
        } else {
            d3.select('#control-btn').classed('hold', false);
        }
    }

    function showResumeText() {
        d3.select('#control-btn').append('div')
            .classed('tooltip', true)
            .style('opacity', 0)
            .text('resuming live stream')
            .transition()
            .duration(100)
            .style('opacity', 1)
            .transition()
            .delay(700)
            .duration(1500)
            .style('opacity', 0)
            .ease(d3.easeSinInOut)
            .remove();
    }

    $('#control-btn').click(function() {
        if (sp.playerState() =='live') {
            hold();
        } else {
            resume();
            showResumeText();
        }
    });

    var inTheaterMode = false;
    function theaterMode(on) {
        var a = document.getElementsByTagName("audio")[0];
        if (on) {
            $('#control-btn').css('display', 'none');
            a.currentTime = 0;
            a.play();
            sp.resume();
            sp.mute();
            ga('send', 'event', 'player', 'theater', '');
        } else {
            $('#control-btn').css('display', 'inline-block');
            a.pause();
            sp.unMute();
        }
        inTheaterMode = on;
    }

    d3.select('#control-btn')
        .on('mouseenter', () => {
            if (sp.playerState() === 'live') {
                d3.select('#control-btn .tooltip')
                    .transition()
                    .duration(200)
                    .style('opacity', 1);
            }
        })
        .on('mouseout', () => {
            d3.select('#control-btn .tooltip')
                .transition()
                .duration(200)
                .style('opacity', 0);
        })
        .on('click', () => {
            d3.select('#control-btn .tooltip')
                .transition()
                .duration(200)
                .style('opacity', 0);
        });

    //this is the listener for keypresses
    $('body').keydown(function(event) {
        if (event.which == 32) { // 'space'
            theaterMode(!inTheaterMode);
        }
        else if (event.which == 37) { // 'left'
            back();
        }
        else if (event.which == 40) { // 'down'
            hold();
        }
        else if (event.which == 39) { // 'right'
            resume();
        } else if (event.which == 27) { // 'escape'
            toggleIntro(true);
        }
    });


    function toggleIntro(on) {
        if (on) {
            $('#intro').css({display: "inline-block", opacity: 1});
            sp.mute();
            $('#control-btn').css('display', 'none');
        } else {
            $('#intro').css("display", "none");
            sp.unMute();
            $('#control-btn').css('display', 'inline-block');
        }
    }

    function loopVideo(elem, start, end) {
        elem.currentTime = start;
        elem.play;
        elem.addEventListener('timeupdate', function () {
            if (elem.currentTime >= end) {
                elem.currentTime = start;
                elem.play();
            }
        }, false);
    }

    function showIfMove(element, duration) {
        var timer,
            duration = duration || 2000;

        $(element).css("display", "none");

        $('body').mousemove(function() {
            if (timer) {
                clearTimeout(timer);
            }
            $(element).css({display: "inline-block", opacity: 1});
            timer = setTimeout(function() {
                $(element).animate({opacity: 0}, 400, function() {
                    $(element).css("display", "none");
                });
            }, duration)
        });
    }

    function bindPages(pages, sp) {
        function showPage(page) {
            pages.forEach(function(pageLink) {
                $(pageLink[1]).toggleClass('hidden', pageLink[1] !== page);
            });

            sp.mute();
        }

        function hidePages() {
            pages.forEach(function(pageLink) {
                $(pageLink[1]).toggleClass('hidden', true);
            });

            sp.unMute();
        }

        pages.forEach(function(p) {
            $(p[1]).toggleClass('hidden', true);
            $(p[0]).click(function() {
                showPage(p[1]);
            })
            $(p[1] + ' .boxclose').click(function() {
                hidePages();
            })

        })
    }

    $('#go-btn').click(function() {
        $('#intro').animate({opacity: 0}, 400, function() {
            toggleIntro(false);
        });

        showIfMove('#links');
    });

    loopVideo($('video')[0], 0, 110);

</script>

</body>
</html>
